<html>
<head>
	<title>Chatter</title>
	<link rel="shortcut icon" href="favicon.ico" />
	<link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />
	<script src='/_ah/channel/jsapi'></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
</head>
<body>
	<script>
	
	  var me = '{{me}}';
	  var my_id = '{{my_id}}';

	  sendChat = function (){
		 var input = document.getElementById('messageBox').value;
		 sendMessage('/post', input);
	  }

	  sendMessage = function(path, param) {
		if (param)
		{
	       path +='?chat='+param;
	    }
	    var xhr = new XMLHttpRequest();
	    xhr.open('POST', path, true);
	    xhr.send();
	  };

	  onOpened = function() {
	    sendMessage('/opened');
	  };

	  onMessage = function(m) {
		var a = JSON.parse(String(m.data));
		var user = a.user;
		var message = a.message;
		var user_id = a.my_id;
		$(document).ready(function(){
		   if(user_id===my_id){
		     $("#outputBox").append('<p class="triangle-isosceles right bubble moveRight"><span class="person"><b>You:</b></span><span class="message"><br>'+message+'</span></p>');
		    }
		   else{
		     $("#outputBox").append('<p class="triangle-isosceles left bubble"><span class="person"><b>'+user+':</b></span><span class="message"><br>'+message+'</span></p>');
		   }
		});
		afterSubmit();
	  }
	
	  openChannel = function() {
	    var token = '{{ token }}';
	    var channel = new goog.appengine.Channel(token);
	    var handler = {
	      'onopen': onOpened,
	      'onmessage': onMessage,
	      'onerror': function() {},
	      'onclose': function() {}
	    };
	    var socket = channel.open(handler);
	    socket.onopen = onOpened;
	    socket.onmessage = onMessage;
	  }

	  initialize = function() {
	    openChannel();
	    var submitButton = document.getElementById('submitButton');
	    submitButton.onclick = new Function('sendChat()');
	  }    
	  
	  setTimeout(initialize, 100); </script>
	
	<div id="loginAddr">{{me}}</div>
	<div id="login"><a href="{{ url }}">{{ url_linktext }}</a></div>
	<div class="logo"><a href="http://people.bu.edu/bt" target="_blank"><img src="/images/logo.png"/></a></div>
	
		<div class="output" id="outputBox">
		</div>
		
			{% for greeting in greetings %}
			  <script type="text/javascript">
              var author = "{{ greeting.author }}";
              var message = "{{greeting.content|escape}}";
             if(author === me){
              $("#outputBox").append('<p class="triangle-isosceles right bubble moveRight"><span class="person"><b>You:</b></span><span class="message"><br>'+message+'</span></p>');
		       }
		     else{		
		     $("#outputBox").append('<p class="triangle-isosceles left bubble"><span class="person"><b>'+author+':</b></span><span class="message"><br>'+message+'</span></p>');
               }
            </script>
		    <script type="text/javascript">
		</script>
			{% endfor %}

		<div class="chatter" id="ChatterDiv">
				<div>
					<input id="messageBox" class="inputBox" type="text" onKeyDown="limitText(140);" 
					onKeyUp="limitText(140);" maxlength="140"><br>
					<p class="count">You have <input readonly type="text" id="countdown" size="2" value="140"> characters left.</p>
				</div>
		            <div><input id="submitButton" type="button" class="chatButton" value="Chatter" id="submitButton"></div>
		</div>
	<!-- Channel script -->
		<script type="text/javascript" src="/scripts/channel.js"></script>
	<!-- Other script -->	
    	<script type="text/javascript" src="/scripts/script.js"></script>
</body>
	</html>